# 整合播客音檔管理功能更新說明

## 更新概要

已成功將 `PodcastAudioManager` 的功能整合到 `interactive_podcast_generator.py` 中，提供了更完整和靈活的音檔處理選項。

## 新增功能

### 1. 多種音頻處理模式

當用戶選擇生成音頻時，現在可以選擇：

```
請選擇音頻處理模式：
1. 僅生成音檔        # 原有功能，只生成音檔
2. 生成音檔 + 自動合併  # 生成後自動合併
3. 使用整合音檔管理器  # 使用完整的管理功能
```

### 2. 智能說話者檔名生成

- **四縣腔**：男聲 (SXM)、女聲 (SXF)
- **海陸腔**：男聲 (HLM)、女聲 (HLF)
- 自動根據腔調和說話者性別生成正確的檔名

### 3. 多說話者音檔管理

- 自動檢測所有說話者的音檔
- 分別顯示每個說話者的音檔資訊
- 支援個別合併或統一合併

### 4. 完整的音檔合併流程

- **個別合併**：每個說話者的音檔分別合併
- **統一合併**：將所有說話者按時間順序合併為單一檔案
- 智能檔名排序，確保正確的播放順序

## 主要改進

### 檔名命名規範
```
格式：{script_name}_{speaker_code}_{segment_index}.wav
範例：tech_news_3articles_SXF_101.wav
```

### 說話者代碼對應
- **敏權** (男聲)：
  - 四縣腔 → SXM
  - 海陸腔 → HLM
- **佳昀** (女聲)：
  - 四縣腔 → SXF  
  - 海陸腔 → HLF

### 音檔合併策略
1. **檢測階段**：自動檢測所有可用的說話者音檔
2. **個別合併**：為每個說話者生成完整音檔
3. **統一合併**：將多個說話者按順序合併

## 使用方式

### 基本流程
1. 選擇主題和腔調
2. 爬取文章並生成腳本
3. 選擇音頻處理模式
4. 系統自動處理音檔生成和合併

### 進階選項

#### 模式1：僅生成音檔
- 使用原有的 `generate_podcast_audio_with_voices()` 函數
- 生成音檔但不進行合併

#### 模式2：生成 + 自動合併
- 生成音檔後自動進行合併
- 支援多說話者智能合併

#### 模式3：整合音檔管理器
- 檢查現有音檔
- 提供重新生成或僅合併的選項
- 完整的音檔管理功能

## 技術實現

### 新增函數

#### `generate_and_merge_podcast_audio()`
- 整合了音檔生成和合併功能
- 支援多說話者處理
- 提供自動和手動模式

#### `use_integrated_audio_manager()`
- 使用 `PodcastAudioManager` 的完整功能
- 智能檢測現有音檔
- 提供靈活的處理選項

#### `merge_all_speakers()`
- 將多個說話者音檔按時間順序合併
- 使用 FFmpeg 進行高品質合併
- 自動排序和檔名管理

### 相容性改進

#### TTS 服務更新
- 更新了 `_generate_readable_filename()` 方法
- 支援更多說話者代碼 (SXM, HLM, HLF)
- 改善檔名生成邏輯

#### 音檔索引系統
- 統一的段落索引格式：`(段落號 + 1) * 100 + (子段落號 + 1)`
- 例如：101, 102, 201, 202...
- 確保正確的排序和合併順序

## 輸出檔案

### 個別說話者合併檔案
```
{script_name}_{speaker_code}_complete.wav
例如：tech_news_3articles_SXF_complete.wav
```

### 統一合併檔案
```
{script_name}_complete_all_speakers.wav
例如：tech_news_3articles_complete_all_speakers.wav
```

### 播放列表檔案
```
{script_name}_playlist.json
包含所有音檔的詳細資訊和播放順序
```

## 錯誤處理

- 自動檢測 FFmpeg 安裝狀態
- 智能處理檔名衝突
- 詳細的錯誤報告和建議
- 優雅的錯誤恢復機制

## 向後相容性

- 原有的音頻生成功能完全保留
- 現有的 API 介面不變
- 舊版本生成的音檔可以正常處理

## 未來擴展

- [ ] 支援更多客語腔調（大埔腔、饒平腔等）
- [ ] 音檔品質和格式選項
- [ ] 批次處理多個腳本
- [ ] 音檔編輯和後處理功能

---

**更新日期**: 2025-08-01  
**版本**: v2.0  
**向後相容**: ✅ 完全相容
